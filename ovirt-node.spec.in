Summary:        The oVirt Node daemons/scripts
Name:           ovirt-node
Version:        @VERSION@
Release:        0%{?dist}%{?extra_release}
Source0:        %{name}-%{version}.tar.gz
License:        GPLv2+
Group:          Applications/System

%define selinux_variants mls strict targeted minimum
%define selinux_policyver %(sed -n 's,.*selinux-policy-\([^/]*\)/.*,\1,p' /usr/share/selinux/devel/policyhelp)
%define modulename %{name}-selinux
Source1:        %{modulename}.te

BuildRoot:      %{_tmppath}/%{name}-%{version}-%{release}-buildroot
URL:            http://www.ovirt.org/
Requires(post):  /sbin/chkconfig
Requires(preun): /sbin/chkconfig
BuildRequires:  libvirt-devel >= 0.5.1
BuildRequires:  dbus-devel hal-devel
Requires:       libvirt >= 0.5.1
Requires:       augeas >= 0.3.5
Requires:       libvirt-qpid >= 0.2.3
Requires:       hal
Requires:       collectd-virt
Requires:       wget
Requires:       cyrus-sasl-gssapi cyrus-sasl cyrus-sasl-lib
Requires:       iscsi-initiator-utils
Requires:       ntp
Requires:       nfs-utils
Requires:       krb5-workstation
Requires:       bash
Requires:       chkconfig
Requires:       bind-utils
# Stupid yum dep solver pulls in older 'qemu' to resolve
# /usr/bin/qemu-img dep. This forces it to pick the new
# qemu-img RPM.
Requires:       qemu-img
Requires:       nc
Requires:       grub
Requires:       /usr/sbin/crond
ExclusiveArch:  %{ix86} x86_64

%define app_root %{_datadir}/%{name}

%description
Provides a series of daemons and support utilities to allow an
oVirt Node to interact with the oVirt Server.

%package stateless
Summary:        oVirt Node for running as embedded hypervisor
Group:          Applications/System
Requires:       %{name} = %{version}-%{release}
Conflicts:      %{name}-stateful
ExclusiveArch:  %{ix86} x86_64

%description stateless
Provides the oVirt Node functionality needed as part of the
ovirt-node-image creation.  This provides a stateless oVirt Node
that runs as a livecd.

%package stateful
Summary:        oVirt Node for running on Fedora Hosts
Group:          Applications/System
Requires:       %{name} = %{version}-%{release}
Conflicts:      %{name}-stateless
ExclusiveArch:  %{ix86} x86_64

%description stateful
Provides the oVirt Node functionality needed to convert an existing
host into a Node in a stateful manner.  Presently intended for use on
the host running the oVirt Appliance.

%package logos
Summary:        oVirt Node Logos
Group:          System Environment/Base
BuildArch:      noarch
Obsoletes:      redhat-logos
Provides:       redhat-logos = 10.0.1-1
Provides:       system-logos = 10.0.1-1
Conflicts:      fedora-logos
Conflicts:      generic-logos
Conflicts:      fedora-logos
Conflicts:      anaconda-images <= 10
Conflicts:      redhat-artwork <= 5.0.5

%description logos
The ovirt-logos package contains various image files which can be
used by the bootloader, anaconda, and other related tools.

%package selinux
Summary:        SELinux policy module supporting ovirt-node
Group:          System Environment/Base
BuildRequires:  checkpolicy, selinux-policy-devel, hardlink
%if "%{selinux_policyver}" != ""
Requires:       selinux-policy >= %{selinux_policyver}
%endif
Requires:       %{name} = %{version}-%{release}
Requires(post):   /usr/sbin/semodule, /sbin/restorecon
Requires(postun): /usr/sbin/semodule, /sbin/restorecon

%description selinux
SELinux policy module supporting ovirt-node

%prep
%setup -q

mkdir SELinux
cp -p %{SOURCE1} SELinux

%build
%configure
make

cd SELinux
for selinuxvariant in %{selinux_variants}; do
  make NAME=${selinuxvariant} -f /usr/share/selinux/devel/Makefile
  mv %{modulename}.pp %{modulename}.pp.${selinuxvariant}
  make NAME=${selinuxvariant} -f /usr/share/selinux/devel/Makefile clean
done
cd -

%install
%{__rm} -rf %{buildroot}
# FIXME move installs into makefile
%{__install} -d -m0755 %{buildroot}%{_sbindir}
%{__install} -d -m0755 %{buildroot}%{_sysconfdir}
%{__install} -d -m0755 %{buildroot}%{_sysconfdir}/chkconfig.d
%{__install} -d -m0755 %{buildroot}%{_initrddir}
%{__install} -d -m0755 %{buildroot}%{app_root}
%{__install} -d -m0755 %{buildroot}%{_sysconfdir}/cron.hourly
%{__install} -d -m0755 %{buildroot}%{_sysconfdir}/logrotate.d

%{__install} -p -m0755 scripts/ovirt-awake %{buildroot}%{_sbindir}
%{__install} -p -m0755 scripts/ovirt-config-boot %{buildroot}%{_sbindir}
%{__install} -p -m0755 scripts/ovirt-config-boot-wrapper %{buildroot}%{_sbindir}
%{__install} -p -m0755 scripts/ovirt-config-collectd %{buildroot}%{_sbindir}
%{__install} -p -m0755 scripts/ovirt-config-hostname %{buildroot}%{_sbindir}
%{__install} -p -m0755 scripts/ovirt-config-logging %{buildroot}%{_sbindir}
%{__install} -p -m0755 scripts/ovirt-config-networking %{buildroot}%{_sbindir}
%{__install} -p -m0755 scripts/ovirt-config-password %{buildroot}%{_sbindir}
%{__install} -p -m0755 scripts/ovirt-config-setup %{buildroot}%{_sbindir}
%{__install} -p -m0755 scripts/ovirt-config-storage %{buildroot}%{_sbindir}
%{__install} -p -m0755 scripts/ovirt-process-config %{buildroot}%{_sbindir}
%{__install} -D -m0755 scripts/ovirt-install-node-stateful %{buildroot}%{_sbindir}
%{__install} -D -m0755 scripts/ovirt-install-node-stateless %{buildroot}%{_sbindir}
%{__install} -D -m0755 scripts/ovirt-uninstall-node-stateful %{buildroot}%{_sbindir}
%{__install} -p -m0755 ovirt-identify-node/ovirt-identify-node %{buildroot}%{_sbindir}
%{__install} -p -m0755 ovirt-listen-awake/ovirt-listen-awake %{buildroot}%{_sbindir}
%{__install} -Dp -m0755 ovirt-listen-awake/ovirt-listen-awake.init %{buildroot}%{_initrddir}/ovirt-listen-awake

# gptsync
%{__install} -p -m0755 gptsync/gptsync %{buildroot}%{_sbindir}
%{__install} -p -m0755 gptsync/showpart %{buildroot}%{_sbindir}
#

%{__install} -p -m0644 scripts/ovirt-functions %{buildroot}%{_initrddir}
%{__install} -p -m0755 scripts/ovirt-early %{buildroot}%{_initrddir}
%{__install} -p -m0755 scripts/ovirt-firstboot %{buildroot}%{_initrddir}
%{__install} -p -m0755 scripts/ovirt %{buildroot}%{_initrddir}
%{__install} -p -m0755 scripts/ovirt-post %{buildroot}%{_initrddir}

%{__install} -p -m0644 scripts/collectd %{buildroot}%{_sysconfdir}/chkconfig.d
%{__install} -p -m0644 scripts/collectd.conf.in %{buildroot}%{_sysconfdir}

%{__install} -p -m0755 kinit/ovirt-kinit %{buildroot}%{_sysconfdir}/cron.hourly

%{__install} -p -m0755 logrotate/ovirt-logrotate %{buildroot}%{_sysconfdir}/cron.hourly
%{__install} -p -m0644 logrotate/ovirt-logrotate.conf %{buildroot}%{_sysconfdir}/logrotate.d

echo "oVirt Node release %{version}-%{release}" > %{buildroot}%{_sysconfdir}/ovirt-release
mkdir -p %{buildroot}/%{_sysconfdir}/default
touch %{buildroot}/%{_sysconfdir}/default/ovirt

cd SELinux
for selinuxvariant in %{selinux_variants}; do
  install -d %{buildroot}%{_datadir}/selinux/${selinuxvariant}
  install -p -m 644 %{modulename}.pp.${selinuxvariant} \
  %{buildroot}%{_datadir}/selinux/${selinuxvariant}/%{modulename}.pp
done
cd -

/usr/sbin/hardlink -cv %{buildroot}%{_datadir}/selinux

# ovirt-logos
# should be ifarch i386
mkdir -p %{buildroot}/boot/grub
install -p -m 644 images/grub-splash.xpm.gz %{buildroot}/boot/grub/splash.xpm.gz
# end i386 bits
mkdir -p %{buildroot}/usr/lib/anaconda-runtime
install -p -m 644 images/syslinux-vesa-splash.jpg %{buildroot}/usr/lib/anaconda-runtime
# ovirt-logos

# default ovirt-config-setup menu options
%{__install} -d -m0755 %{buildroot}%{_sysconfdir}/ovirt-config-setup.d
%{__ln_s} ../..%{_sbindir}/ovirt-config-storage %{buildroot}%{_sysconfdir}/ovirt-config-setup.d/"00_Disk Partitioning"
%{__ln_s} ../..%{_sbindir}/ovirt-config-password %{buildroot}%{_sysconfdir}/ovirt-config-setup.d/"05_Administrator Password"
%{__ln_s} ../..%{_sbindir}/ovirt-config-hostname %{buildroot}%{_sysconfdir}/ovirt-config-setup.d/"10_Set Hostname"
%{__ln_s} ../..%{_sbindir}/ovirt-config-networking %{buildroot}%{_sysconfdir}/ovirt-config-setup.d/"15_Networking Setup"
%{__ln_s} ../..%{_sbindir}/ovirt-config-logging %{buildroot}%{_sysconfdir}/ovirt-config-setup.d/"30_Logging Setup"
%{__ln_s} ../..%{_sbindir}/ovirt-config-collectd %{buildroot}%{_sysconfdir}/ovirt-config-setup.d/"35_Collectd Setup"
%{__ln_s} ../..%{_sbindir}/ovirt-config-boot-wrapper %{buildroot}%{_sysconfdir}/ovirt-config-setup.d/"99_Local install and reboot"


%clean
%{__rm} -rf %{buildroot}

%post
# Setup basic collectd configuration
sed '/<Plugin network>/,/<\/Plugin>/d' /etc/collectd.conf.in > /etc/collectd.conf

%post stateless
/sbin/chkconfig --add ovirt-early
/sbin/chkconfig --add ovirt-firstboot
/sbin/chkconfig --add ovirt
/sbin/chkconfig --add ovirt-post
# this is ugly; we need collectd to start *after* libvirtd, so we own the
# /etc/chkconfig.d/collectd file, and then have to re-define collectd here
/sbin/chkconfig --add collectd

%preun stateless
if [ "$1" = 0 ] ; then
  /sbin/chkconfig --del ovirt-early
  /sbin/chkconfig --del ovirt-firstboot
  /sbin/chkconfig --del ovirt
  /sbin/chkconfig --del ovirt-post
fi

%post stateful
/sbin/chkconfig --add collectd
/sbin/chkconfig --add ovirt-listen-awake

%preun stateful
if [ "$1" = 0 ] ; then
  /sbin/chkconfig --del ovirt-listen-awake
fi

%post selinux
for selinuxvariant in %{selinux_variants}; do
  /usr/sbin/semodule -s ${selinuxvariant} -i \
    %{_datadir}/selinux/${selinuxvariant}/%{modulename}.pp &> /dev/null || :
done

%postun selinux
if [ $1 -eq 0 ] ; then
  for selinuxvariant in %{selinux_variants}; do
    /usr/sbin/semodule -s ${selinuxvariant} -r %{modulename} &> /dev/null || :
  done
fi

%files selinux
%defattr(-,root,root,0755)
%doc SELinux/*
%{_datadir}/selinux/*/%{modulename}.pp

%files logos
%defattr(-, root, root)
%doc COPYING
# should be ifarch i386
/boot/grub/splash.xpm.gz
# end i386 bits
/usr/lib/anaconda-runtime/*.jpg

%files stateless
%defattr(-,root,root,0755)
%{_sbindir}/ovirt-awake
%{_sbindir}/ovirt-config-boot
%{_sbindir}/ovirt-config-boot-wrapper
%{_sbindir}/ovirt-config-collectd
%{_sbindir}/ovirt-config-hostname
%{_sbindir}/ovirt-config-logging
%{_sbindir}/ovirt-config-networking
%{_sbindir}/ovirt-config-password
%{_sbindir}/ovirt-config-setup
%{_sbindir}/ovirt-config-storage
%{_sbindir}/ovirt-process-config
%{_sbindir}/ovirt-install-node-stateless
%{_sbindir}/gptsync
%{_sbindir}/showpart
%{_initrddir}/ovirt-early
%{_initrddir}/ovirt-firstboot
%{_initrddir}/ovirt
%{_initrddir}/ovirt-post
%config %{_sysconfdir}/cron.hourly/ovirt-kinit
%config %{_sysconfdir}/logrotate.d/ovirt-logrotate.conf
%config %{_sysconfdir}/cron.hourly/ovirt-logrotate
%{_sysconfdir}/ovirt-config-setup.d

%files stateful
%defattr(-,root,root,0755)
%{_sbindir}/ovirt-listen-awake
%{_sbindir}/ovirt-install-node-stateful
%{_sbindir}/ovirt-uninstall-node-stateful
%{_initrddir}/ovirt-listen-awake

%files
%defattr(-,root,root,0755)
%{_sbindir}/ovirt-awake
%{_sbindir}/ovirt-identify-node
%defattr(-,root,root,0644)
%{_initrddir}/ovirt-functions
%{_sysconfdir}/collectd.conf.in
%{_sysconfdir}/chkconfig.d/collectd
%config %attr(0644,root,root) %{_sysconfdir}/ovirt-release
%config %attr(0644,root,root) %{_sysconfdir}/default/ovirt
%doc ovirt-identify-node/README ovirt-identify-node/NEWS
%doc ovirt-identify-node/AUTHOR ovirt-identify-node/ChangeLog
%doc ovirt-identify-node/COPYING

%changelog
* Thu Dec 11 2008 Perry Myers <pmyers@redhat.com> - 0.96
- Subpackage stateful/stateless to separate out functionality for
  embedded Node and Node running as part of already installed OS
- ovirt-config-* setup scripts for standalone mode

* Thu Sep 11 2008 Chris Lalancette <clalance@redhat.com> - 0.92 0.7
- Add the ovirt-install- and ovirt-uninstall-node scripts, and refactor
  post to accomodate

* Mon Sep  8 2008 Jim Meyering <meyering@redhat.com> - 0.92 0.6
- Update ovirt-identify-node's build rule.

* Fri Aug 22 2008 Chris Lalancette <clalance@redhat.com> - 0.92 0.5
- Add the ovirt-listen-awake daemon to the RPM

* Fri Aug 22 2008 Chris Lalancette <clalance@redhat.com> - 0.92 0.4
- Re-arrange the directory layout, in preparation for ovirt-listen-awake

* Tue Jul 29 2008 Perry Myers <pmyers@redhat.com> - 0.92 0.2
- Added /etc/ovirt-release and merged ovirt-setup into spec file

* Wed Jul 02 2008 Darryl Pierce <dpierce@redhat.com> - 0.92 0.2
- Added log rotation to limit file system writes.

* Mon Jun 30 2008 Perry Myers <pmyers@redhat.com> - 0.92 0.1
- Add in sections of kickstart post, general cleanup
